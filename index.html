<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PolicyLab — Holistic, Visual, Interactive</title>
<style>
  :root{
    --bg:#0f172a; --ink:#e6eefc; --muted:#a9b6cf; --card:#0b1224;
    --line:#1e2a44; --accent:#7fb3ff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --chip:#0e1a34; --tint:#0c1428; --white:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:radial-gradient(1200px 800px at 15% -10%,#1a2750 0%,#0f172a 60%);color:var(--ink);
            font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
  header{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:clamp(20px,3.2vw,28px);letter-spacing:.2px}
  header .sub{color:var(--muted);font-size:12px}
  .wrap{display:grid;grid-template-columns:280px 1fr;gap:14px;max-width:1200px;margin:0 auto;padding:14px}
  @media(max-width:980px){.wrap{grid-template-columns:1fr}}
  nav{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--line);border-radius:14px}
  .nav-inner{padding:12px}
  .btn{appearance:none;border:1px solid #29406e;background:#0d1832;color:#dbe7ff;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent}
  .btn.small{padding:6px 10px;font-size:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #263a66;color:#cfe1ff;padding:5px 8px;border-radius:999px;font-size:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel{padding:14px}
  .panel h2{margin:0 0 8px;font-size:16px;color:#d7e6ff}
  .panel h3{margin:12px 0 6px;font-size:13px;color:#d7e6ff}
  .hint{color:var(--muted);font-size:12px}
  input[type=text],input[type=number],textarea,select{width:100%;background:#0c1428;border:1px solid #223456;border-radius:12px;color:#e6f0ff;padding:9px 10px}
  textarea{min-height:84px}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:repeat(3,1fr)}
  @media(max-width:900px){.two,.three{grid-template-columns:1fr}}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kv{display:grid;grid-template-columns:1fr 80px;gap:8px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #223456;background:#0c1428;color:#cfe1ff;font-size:12px}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .legend i{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px;border:1px solid #1f2b47}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:var(--line);margin:8px 0}
  .right{margin-left:auto}
  canvas{display:block;background:#0c1428;border:1px solid #223456;border-radius:12px}
  .stage{position:relative;background:#0c1428;border:1px solid #223456;border-radius:12px;height:460px;overflow:hidden}
  .node{position:absolute;padding:8px 10px;border-radius:10px;border:1px solid #2a3e68;color:#e6f0ff;cursor:grab;user-select:none;box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .node:active{cursor:grabbing}
  .type-driver{background:#0e2b3a}
  .type-policy{background:#243056}
  .type-output{background:#2f214f}
  .type-outcome{background:#2b3b20}
  .type-harm{background:#4a1f1f}
  .badge{background:#0f1832;border:1px solid #243356;border-radius:8px;padding:2px 6px;font-size:11px;color:#cfe1ff}
  .hot{color:#ffd166}
  .ok{color:#22c55e}
  .bad{color:#ef4444}
</style>
</head>
<body>
  <header>
    <div>
      <h1>PolicyLab</h1>
      <div class="sub">Holistic, visual, and interactive policy tools. Runs locally in your browser, no data is collected by LaMCRESA.</div>
    </div>
    <div class="toolbar">
      <button id="presetDigital" class="btn small">Load demo</button>
      <button id="exportJson" class="btn small">Export JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="importJson" class="btn small ghost">Import JSON</button>
    </div>
  </header>

  <main class="wrap">
    <nav class="card">
      <div class="nav-inner">
        <div class="row" style="justify-content:space-between;align-items:center">
          <span class="chip">Tools</span>
          <span id="saveStatus" class="hint">Autosaved</span>
        </div>
        <div class="divider"></div>
        <div class="grid">
          <button class="btn small" data-panel="mcda">1. MCDA Board</button>
          <button class="btn small" data-panel="causal">2. Causal Map</button>
          <button class="btn small" data-panel="risk">3. Risk Bow-Tie</button>
          <button class="btn small" data-panel="capacity">4. Capacity Heatmap</button>
          <button class="btn small" data-panel="synth">5. Synthesis</button>
        </div>
        <div class="divider"></div>
        <div class="grid">
          <div class="kv">
            <input id="scenarioTitle" type="text" placeholder="Scenario title" />
            <span class="badge">meta</span>
          </div>
          <textarea id="scenarioBrief" placeholder="Short brief..."></textarea>
          <select id="domain">
            <option>Digital markets and competition</option>
            <option>Data protection and privacy</option>
            <option>Environmental regulation</option>
            <option>Public health</option>
            <option>IP and innovation policy</option>
            <option>Infrastructure and utilities</option>
          </select>
        </div>
      </div>
    </nav>

    <!-- PANELS -->
    <section class="card" id="panel-mcda">
      <div class="panel">
        <h2>MCDA Board</h2>
        <div class="hint">Weight criteria and score instruments. See rankings and a weight "tornado".</div>
        <div class="divider"></div>

        <div class="grid three">
          <div>
            <h3>Criteria weights</h3>
            <div id="critList" class="grid"></div>
            <div class="row" style="margin-top:6px">
              <button id="addCrit" class="btn small">Add criterion</button>
              <button id="resetCrit" class="btn small ghost">Reset</button>
              <span class="hint right">Sum auto-normalizes</span>
            </div>
          </div>

          <div>
            <h3>Add instrument</h3>
            <input id="insName" type="text" placeholder="Instrument name" />
            <textarea id="insWhy" placeholder="Justification (optional)"></textarea>
            <div id="insScores" class="grid"></div>
            <div class="row" style="margin-top:6px">
              <button id="addIns" class="btn small">Add</button>
              <button id="clearIns" class="btn small ghost">Clear all</button>
            </div>
            <div id="insList" class="grid" style="margin-top:8px"></div>
          </div>

          <div>
            <h3>Notes</h3>
            <ul class="hint" style="margin:0;padding-left:16px">
              <li>Weights 0–100; scores 1–5</li>
              <li>Weighted score uses normalized weights</li>
              <li>Sensitivity shows most influential criteria</li>
            </ul>
            <div class="legend" style="margin-top:8px">
              <span><i style="background:#7fb3ff"></i><span class="hint">Ranking bars</span></span>
              <span><i style="background:#ffd166"></i><span class="hint">Tornado weights</span></span>
            </div>
          </div>
        </div>

        <div class="grid two" style="margin-top:10px">
          <div>
            <h3>Instrument ranking</h3>
            <canvas id="mcdaRank" width="520" height="300"></canvas>
          </div>
          <div>
            <h3>Weight tornado</h3>
            <canvas id="mcdaTornado" width="520" height="300"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="panel-causal" style="display:none">
      <div class="panel">
        <h2>Causal Map</h2>
        <div class="hint">Add nodes, drag to position, link them. Export as JSON. Color denotes role.</div>
        <div class="divider"></div>
        <div class="row">
          <select id="nodeType" class="btn small">
            <option value="driver">Driver</option>
            <option value="policy">Policy</option>
            <option value="output">Output</option>
            <option value="outcome">Outcome</option>
            <option value="harm">Harm</option>
          </select>
          <input id="nodeText" type="text" placeholder="Node text" />
          <button id="addNode" class="btn small">Add node</button>
          <button id="linkMode" class="btn small ghost">Link mode</button>
          <button id="clearMap" class="btn small ghost">Clear</button>
          <button id="exportMap" class="btn small">Export JSON</button>
          <input id="importMapFile" type="file" accept="application/json" style="display:none">
          <button id="importMap" class="btn small ghost">Import</button>
          <span id="mapStatus" class="hint right">idle</span>
        </div>
        <div class="divider"></div>
        <div class="stage" id="mapStage">
          <svg id="mapSVG" width="100%" height="100%" style="position:absolute;left:0;top:0;pointer-events:none">
            <defs>
              <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                <path d="M0,0 L0,6 L9,3 z" fill="#7fb3ff"/>
              </marker>
            </defs>
          </svg>
        </div>
        <div class="legend" style="margin-top:8px">
          <span class="pill">Driver</span>
          <span class="pill">Policy</span>
          <span class="pill">Output</span>
          <span class="pill">Outcome</span>
          <span class="pill">Harm</span>
        </div>
      </div>
    </section>

    <section class="card" id="panel-risk" style="display:none">
      <div class="panel">
        <h2>Risk Register & Bow-Tie</h2>
        <div class="hint">Score likelihood and impact 1–5. Place on heatmap. Track controls.</div>
        <div class="divider"></div>
        <div class="grid three">
          <div>
            <h3>Add risk</h3>
            <input id="riskTitle" type="text" placeholder="Risk title" />
            <div class="row">
              <label class="pill">Likelihood <input id="riskLik" type="number" min="1" max="5" value="3" style="width:64px;margin-left:6px"></label>
              <label class="pill">Impact <input id="riskImp" type="number" min="1" max="5" value="3" style="width:64px;margin-left:6px"></label>
            </div>
            <textarea id="riskCauses" placeholder="Causes (semicolon separated)"></textarea>
            <textarea id="riskConsq" placeholder="Consequences (semicolon separated)"></textarea>
            <textarea id="riskPre" placeholder="Preventive controls"></textarea>
            <textarea id="riskPost" placeholder="Mitigating controls"></textarea>
            <div class="row">
              <button id="addRisk" class="btn small">Add</button>
              <button id="clearRisks" class="btn small ghost">Clear</button>
            </div>
          </div>
          <div>
            <h3>Heatmap</h3>
            <canvas id="riskMap" width="520" height="420"></canvas>
          </div>
          <div>
            <h3>Bow-Tie</h3>
            <div id="bowtie" class="grid two" style="gap:6px">
              <div>
                <div class="badge">Causes</div>
                <ul id="btLeft" class="hint" style="min-height:120px;margin:6px 0 10px 16px"></ul>
                <div class="badge">Preventive</div>
                <ul id="btPre" class="hint" style="min-height:80px;margin:6px 0 10px 16px"></ul>
              </div>
              <div>
                <div class="badge">Consequences</div>
                <ul id="btRight" class="hint" style="min-height:120px;margin:6px 0 10px 16px"></ul>
                <div class="badge">Mitigating</div>
                <ul id="btPost" class="hint" style="min-height:80px;margin:6px 0 10px 16px"></ul>
              </div>
            </div>
            <div class="hint">Click a dot on the heatmap to preview its bow-tie here.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="panel-capacity" style="display:none">
      <div class="panel">
        <h2>Institutional Capacity Heatmap</h2>
        <div class="hint">Click cells to cycle 0–5. Colors show readiness. Summary bars at right.</div>
        <div class="divider"></div>
        <div class="row">
          <input id="agencyName" type="text" placeholder="Add agency (Enter)" />
          <input id="capName" type="text" placeholder="Add capability (Enter)" />
          <button id="resetCap" class="btn small ghost">Reset matrix</button>
        </div>
        <div id="capTableWrap" class="panel" style="padding:0;margin-top:8px">
          <div id="capTable" class="hint" style="padding:10px">Add at least one agency and capability.</div>
        </div>
      </div>
    </section>

    <section class="card" id="panel-synth" style="display:none">
      <div class="panel">
        <h2>Synthesis</h2>
        <div class="hint">Compile a concise summary across tools. Edit in place. Export Markdown.</div>
        <div class="divider"></div>
        <div class="row">
          <button id="compile" class="btn small">Compile</button>
          <button id="exportMd" class="btn small ghost">Export Markdown</button>
        </div>
        <article id="output" class="mono" contenteditable="true" style="margin-top:8px;white-space:pre-wrap;background:#0c1428;border:1px solid #223456;border-radius:12px;padding:12px;min-height:220px"></article>
      </div>
    </section>
  </main>

  <script>
  // --------------------------- Global State ---------------------------
  const state = {
    meta:{title:"", brief:"", domain:"Digital markets and competition"},
    mcda:{criteria:[
      {name:"Effectiveness", w:30},
      {name:"Feasibility", w:20},
      {name:"Cost efficiency", w:20},
      {name:"Rights impact", w:15},
      {name:"Competition impact", w:10},
      {name:"Admin burden", w:5}
    ], instruments:[]},
    causal:{nodes:[], links:[]}, // node {id,x,y,text,type}, link {a,b}
    risks:[], // {id,title,lik,imp,causes[],consq[],pre[],post[]}
    cap:{agencies:["Regulator","Data Protection Authority"], caps:["Staffing","IT systems","Legal powers","Budget"], levels:[]}
  };
  function autosave(){
    localStorage.setItem("policylab_min_v2", JSON.stringify(state));
    document.getElementById("saveStatus").textContent="Autosaved";
  }
  (function restore(){
    const raw=localStorage.getItem("policylab_min_v2"); if(!raw) return;
    try{ const s=JSON.parse(raw); Object.assign(state,s); }catch{}
  })();

  // --------------------------- Nav switching ---------------------------
  const panels = ["mcda","causal","risk","capacity","synth"];
  document.querySelectorAll('nav .btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id=b.dataset.panel;
      panels.forEach(p=> document.getElementById("panel-"+p).style.display = (p===id)? "block":"none");
    });
  });

  // --------------------------- Meta bindings ---------------------------
  const titleEl = document.getElementById('scenarioTitle');
  const briefEl = document.getElementById('scenarioBrief');
  const domainEl = document.getElementById('domain');
  titleEl.value = state.meta.title||"";
  briefEl.value = state.meta.brief||"";
  domainEl.value = state.meta.domain||"Digital markets and competition";
  titleEl.addEventListener('input', e=>{ state.meta.title=e.target.value; autosave(); });
  briefEl.addEventListener('input', e=>{ state.meta.brief=e.target.value; autosave(); });
  domainEl.addEventListener('input', e=>{ state.meta.domain=e.target.value; autosave(); });

  // --------------------------- MCDA ---------------------------
  const critList = document.getElementById('critList');
  const insScores = document.getElementById('insScores');
  const insList = document.getElementById('insList');
  const rankCv = document.getElementById('mcdaRank').getContext('2d');
  const tornCv = document.getElementById('mcdaTornado').getContext('2d');

  function renderCriteria(){
    critList.innerHTML='';
    state.mcda.criteria.forEach((c,i)=>{
      const row=document.createElement('div');
      row.className='kv';
      row.innerHTML = `<input type="text" value="${c.name}" data-i="${i}" class="crit-name">
                       <input type="number" min="0" max="100" value="${c.w}" data-i="${i}" class="crit-weight">`;
      critList.appendChild(row);
    });
    critList.querySelectorAll('.crit-name').forEach(el=> el.addEventListener('input', e=>{
      const i=+e.target.dataset.i; state.mcda.criteria[i].name=e.target.value; renderInsScoreInputs(); drawMCDA(); autosave();
    }));
    critList.querySelectorAll('.crit-weight').forEach(el=> el.addEventListener('input', e=>{
      const i=+e.target.dataset.i; state.mcda.criteria[i].w=Math.max(0,Math.min(100, +e.target.value||0)); drawMCDA(); autosave();
    }));
    renderInsScoreInputs();
  }
  function renderInsScoreInputs(){
    insScores.innerHTML='';
    state.mcda.criteria.forEach((c,i)=>{
      const wrap=document.createElement('div'); wrap.className='kv';
      wrap.innerHTML=`<label class="hint">${c.name}</label>
                      <input type="number" min="1" max="5" value="3" data-i="${i}" class="ins-score">`;
      insScores.appendChild(wrap);
    });
  }
  function renderInstruments(){
    insList.innerHTML='';
    state.mcda.instruments.forEach((ins,idx)=>{
      const box=document.createElement('div');
      box.className='panel'; box.style.padding='10px';
      const sPreview = state.mcda.criteria.map((c,i)=> `${c.name}: ${ins.scores[i]??3}/5`).join(' | ');
      box.innerHTML = `<div class="row"><strong>${ins.name}</strong><span class="hint">• ${ins.why||''}</span><span class="right"><button class="btn small ghost" data-del="${idx}">Remove</button></span></div>
                       <div class="hint" style="margin-top:6px">${sPreview}</div>`;
      insList.appendChild(box);
    });
    insList.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=>{
      state.mcda.instruments.splice(+b.dataset.del,1); renderInstruments(); drawMCDA(); autosave();
    }));
  }
  function normWeights(){
    const sum = state.mcda.criteria.reduce((a,c)=>a+(+c.w||0),0)||1;
    return state.mcda.criteria.map(c=> (+c.w||0)/sum);
  }
  function computeScores(){
    const W = normWeights();
    return state.mcda.instruments.map(ins=>{
      const s = state.mcda.criteria.map((_,i)=> (+ins.scores[i]||0));
      const z = s.reduce((a,si,i)=> a + W[i]*(si/5), 0);
      return {name:ins.name, score:z, why:ins.why||''};
    }).sort((a,b)=> b.score-a.score);
  }
  function drawBars(ctx, items, color="#7fb3ff"){
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    const W=ctx.canvas.width, H=ctx.canvas.height, pad=36;
    const max = Math.max(0.01, ...items.map(x=>x.score||x.weight));
    const bw = Math.max(10, (H-2*pad)/items.length - 8);
    items.forEach((it,idx)=>{
      const y = pad + idx*((H-2*pad)/items.length);
      const w = (W-2*pad) * ((it.score||it.weight)/max);
      ctx.fillStyle=color; ctx.fillRect(pad, y, w, bw);
      ctx.fillStyle="#a9b6cf"; ctx.font="12px Inter"; ctx.fillText(it.name, pad, y-4);
      ctx.fillStyle=varInk(); ctx.font="12px Inter";
      ctx.fillText(((it.score||it.weight)*100).toFixed(0), pad+w+6, y+bw-2);
    });
  }
  function varInk(){ return getComputedStyle(document.documentElement).getPropertyValue('--ink') || '#e6eefc'; }
  function drawMCDA(){
    const scores = computeScores();
    drawBars(rankCv, scores.map(s=>({name:s.name, score:s.score})), "#7fb3ff");
    const W = normWeights();
    const items = state.mcda.criteria.map((c,i)=> ({name:c.name, weight:W[i]})).sort((a,b)=>b.weight-a.weight);
    drawBars(tornCv, items, "#ffd166");
  }
  document.getElementById('addCrit').addEventListener('click', ()=>{
    state.mcda.criteria.push({name:"New criterion", w:10}); renderCriteria(); drawMCDA(); autosave();
  });
  document.getElementById('resetCrit').addEventListener('click', ()=>{
    state.mcda.criteria=[{name:"Effectiveness",w:30},{name:"Feasibility",w:20},{name:"Cost efficiency",w:20},{name:"Rights impact",w:15},{name:"Competition impact",w:10},{name:"Admin burden",w:5}];
    renderCriteria(); drawMCDA(); autosave();
  });
  document.getElementById('addIns').addEventListener('click', ()=>{
    const name = document.getElementById('insName').value.trim(); if(!name) return;
    const why = document.getElementById('insWhy').value.trim();
    const scores = Array.from(document.querySelectorAll('.ins-score')).map(el=> Math.max(1,Math.min(5, +el.value||3)));
    state.mcda.instruments.push({name, why, scores});
    document.getElementById('insName').value=''; document.getElementById('insWhy').value='';
    renderInstruments(); drawMCDA(); autosave();
  });
  document.getElementById('clearIns').addEventListener('click', ()=>{ state.mcda.instruments=[]; renderInstruments(); drawMCDA(); autosave(); });

  renderCriteria(); renderInstruments(); drawMCDA();

  // --------------------------- Causal Map ---------------------------
  const stage = document.getElementById('mapStage');
  const svg = document.getElementById('mapSVG');
  let linkMode=false, linkFrom=null, drag=null, dragOff={x:0,y:0};
  function addNode(text,type,x=40,y=40){
    const id = crypto.randomUUID();
    const el = document.createElement('div'); el.className=`node type-${type}`; el.textContent=text;
    el.style.left=x+'px'; el.style.top=y+'px'; el.dataset.id=id; el.dataset.type=type;
    el.addEventListener('mousedown', e=>{ drag=el; const r=el.getBoundingClientRect(), s=stage.getBoundingClientRect(); dragOff.x=e.clientX-r.left; dragOff.y=e.clientY-r.top; e.preventDefault(); });
    el.addEventListener('click', e=>{
      if(linkMode){
        if(!linkFrom){ linkFrom=el; el.style.outline='2px solid #7fb3ff'; }
        else if(linkFrom!==el){ linkFrom.style.outline=''; state.causal.links.push({a:linkFrom.dataset.id, b:el.dataset.id}); linkFrom=null; drawLinks(); autosave(); }
      }
    });
    stage.appendChild(el);
    state.causal.nodes.push({id,text,type,x,y});
    drawLinks(); autosave();
  }
  function drawLinks(){
    svg.innerHTML = `<defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#7fb3ff"/></marker></defs>`;
    state.causal.links.forEach(L=>{
      const A = stage.querySelector(`[data-id="${L.a}"]`);
      const B = stage.querySelector(`[data-id="${L.b}"]`);
      if(!A||!B) return;
      const ar = A.getBoundingClientRect(), br=B.getBoundingClientRect(), sr=stage.getBoundingClientRect();
      const ax = ar.left - sr.left + ar.width/2, ay = ar.top - sr.top + ar.height/2;
      const bx = br.left - sr.left + br.width/2, by = br.top - sr.top + br.height/2;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', ax); line.setAttribute('y1', ay); line.setAttribute('x2', bx); line.setAttribute('y2', by);
      line.setAttribute('stroke', '#7fb3ff'); line.setAttribute('stroke-width','2'); line.setAttribute('marker-end','url(#arrow)');
      svg.appendChild(line);
    });
  }
  stage.addEventListener('mousemove', e=>{
    if(!drag) return;
    const r=stage.getBoundingClientRect();
    const x = Math.max(10, Math.min(r.width-80, e.clientX - r.left - dragOff.x));
    const y = Math.max(10, Math.min(r.height-34, e.clientY - r.top - dragOff.y));
    drag.style.left=x+'px'; drag.style.top=y+'px';
    const id=drag.dataset.id; const n=state.causal.nodes.find(n=>n.id===id); if(n){ n.x=x; n.y=y; }
    drawLinks();
  });
  window.addEventListener('mouseup', ()=>{ drag=null; autosave(); });

  document.getElementById('addNode').addEventListener('click', ()=>{
    const t=document.getElementById('nodeText').value.trim(); if(!t) return;
    const type=document.getElementById('nodeType').value;
    addNode(t,type, 40+Math.random()*200, 40+Math.random()*200);
    document.getElementById('nodeText').value='';
  });
  document.getElementById('linkMode').addEventListener('click', ()=>{
    linkMode=!linkMode; linkFrom=null; document.getElementById('mapStatus').textContent = linkMode? "linking…" : "idle";
    stage.querySelectorAll('.node').forEach(n=> n.style.outline='');
  });
  document.getElementById('clearMap').addEventListener('click', ()=>{
    state.causal.nodes=[]; state.causal.links=[]; stage.querySelectorAll('.node').forEach(n=>n.remove()); drawLinks(); autosave();
  });
  document.getElementById('exportMap').addEventListener('click', ()=>{
    const data = JSON.stringify(state.causal,null,2);
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download='causal-map.json'; a.click();
  });
  document.getElementById('importMap').addEventListener('click', ()=> document.getElementById('importMapFile').click());
  document.getElementById('importMapFile').addEventListener('change', ()=>{
    const f=document.getElementById('importMapFile').files[0]; if(!f) return;
    const r=new FileReader(); r.onload=e=>{ try{
      const obj=JSON.parse(e.target.result); state.causal=obj||{nodes:[],links:[]};
      // rebuild
      stage.querySelectorAll('.node').forEach(n=>n.remove());
      (state.causal.nodes||[]).forEach(n=> addNode(n.text,n.type,n.x,n.y));
      state.causal.links = (obj.links||[]); drawLinks(); autosave();
    }catch{ alert('Invalid map JSON'); }};
    r.readAsText(f);
  });

  // --------------------------- Risk ---------------------------
  const riskMap = document.getElementById('riskMap').getContext('2d');
  function drawRiskMap(){
    const ctx=riskMap, W=ctx.canvas.width, H=ctx.canvas.height, pad=40;
    ctx.clearRect(0,0,W,H);
    // grid 5x5
    for(let i=0;i<=5;i++){
      const x=pad+i*(W-2*pad)/5, y=pad+i*(H-2*pad)/5;
      ctx.strokeStyle="#1e2a44"; ctx.strokeRect(pad,pad,W-2*pad,H-2*pad);
      ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x,H-pad); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
    }
    ctx.fillStyle="#a9b6cf"; ctx.font="12px Inter"; ctx.fillText("Likelihood →", W/2-38, H-10);
    ctx.save(); ctx.translate(14,H/2+26); ctx.rotate(-Math.PI/2); ctx.fillText("Impact ↑",0,0); ctx.restore();

    // points
    state.risks.forEach(r=>{
      const x = pad + (r.lik-0.5)*(W-2*pad)/5;
      const y = H-pad - (r.imp-0.5)*(H-2*pad)/5;
      const color = r.lik*r.imp>=16 ? "#ef4444" : r.lik*r.imp>=9 ? "#f59e0b" : "#22c55e";
      ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,7,0,Math.PI*2); ctx.fill();
      ctx.fillStyle="#a9b6cf"; ctx.fillText(r.title.slice(0,18), x+10, y+4);
    });
  }
  function refreshBowTie(r){
    const toList = (id, arr)=> document.getElementById(id).innerHTML = (arr||[]).map(x=> `<li>${x}</li>`).join('');
    toList('btLeft', r.causes||[]); toList('btRight', r.consq||[]);
    toList('btPre', r.pre||[]); toList('btPost', r.post||[]);
  }
  document.getElementById('addRisk').addEventListener('click', ()=>{
    const title=document.getElementById('riskTitle').value.trim(); if(!title) return;
    const lik=Math.max(1,Math.min(5, +document.getElementById('riskLik').value||3));
    const imp=Math.max(1,Math.min(5, +document.getElementById('riskImp').value||3));
    const causes=(document.getElementById('riskCauses').value||'').split(';').map(s=>s.trim()).filter(Boolean);
    const consq=(document.getElementById('riskConsq').value||'').split(';').map(s=>s.trim()).filter(Boolean);
    const pre=(document.getElementById('riskPre').value||'').split(';').map(s=>s.trim()).filter(Boolean);
    const post=(document.getElementById('riskPost').value||'').split(';').map(s=>s.trim()).filter(Boolean);
    state.risks.push({id:crypto.randomUUID(), title, lik, imp, causes, consq, pre, post});
    ['riskTitle','riskCauses','riskConsq','riskPre','riskPost'].forEach(id=> document.getElementById(id).value='');
    drawRiskMap(); autosave();
  });
  document.getElementById('clearRisks').addEventListener('click', ()=>{ state.risks=[]; drawRiskMap(); autosave(); });
  // click to show bow-tie
  document.getElementById('riskMap').addEventListener('click', (e)=>{
    const rect=e.target.getBoundingClientRect(), x=e.clientX-rect.left, y=e.clientY-rect.top;
    const ctx=riskMap, W=ctx.canvas.width, H=ctx.canvas.height, pad=40;
    const hit = state.risks.find(r=>{
      const rx=pad + (r.lik-0.5)*(W-2*pad)/5;
      const ry=H-pad - (r.imp-0.5)*(H-2*pad)/5;
      return Math.hypot(rx - x*(W/rect.width), ry - y*(H/rect.height)) < 10;
    });
    if(hit) refreshBowTie(hit);
  });
  drawRiskMap();

  // --------------------------- Capacity Heatmap ---------------------------
  const agencyEl=document.getElementById('agencyName');
  const capEl=document.getElementById('capName');
  const wrap=document.getElementById('capTable');
  function ensureMatrix(){
    const R=state.cap.agencies.length, C=state.cap.caps.length;
    if(!Array.isArray(state.cap.levels)) state.cap.levels=[];
    for(let i=0;i<R;i++){ if(!Array.isArray(state.cap.levels[i])) state.cap.levels[i]=[]; for(let j=0;j<C;j++){ if(typeof state.cap.levels[i][j]!=='number') state.cap.levels[i][j]=0; } }
  }
  function colorFor(v){ const g = ['#0c1428','#163459','#1f5a7a','#2b7a5f','#3fa34d','#63c74d']; return g[Math.max(0,Math.min(5,v))]; }
  function renderCap(){
    ensureMatrix();
    if(!state.cap.agencies.length || !state.cap.caps.length){ wrap.textContent="Add at least one agency and capability."; return; }
    let html = `<table style="border-collapse:collapse;width:100%"><thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #223456">Agency</th>`;
    state.cap.caps.forEach(c=> html+= `<th style="padding:8px;border-bottom:1px solid #223456;text-align:center">${c}</th>`);
    html += `<th style="padding:8px;border-bottom:1px solid #223456;text-align:center">Readiness</th></tr></thead><tbody>`;
    state.cap.agencies.forEach((a,i)=>{
      html += `<tr><td style="padding:8px;border-bottom:1px solid #223456">${a}</td>`;
      state.cap.caps.forEach((_,j)=>{
        const v=state.cap.levels[i][j]||0;
        html += `<td data-i="${i}" data-j="${j}" style="padding:8px;border-bottom:1px solid #223456;text-align:center">
                   <div style="width:36px;height:18px;margin:0 auto;border:1px solid #1f2b47;border-radius:6px;background:${colorFor(v)}">${v}</div>
                 </td>`;
      });
      const avg = Math.round(100*(state.cap.levels[i].reduce((a,b)=>a+(b||0),0)/(state.cap.caps.length*5 || 1)));
      html += `<td style="padding:8px;border-bottom:1px solid #223456;text-align:center"><span class="badge">${avg}%</span></td></tr>`;
    });
    html += `</tbody></table>`;
    wrap.innerHTML=html;
    wrap.querySelectorAll('td[data-i]').forEach(td=>{
      td.addEventListener('click', ()=>{
        const i=+td.dataset.i, j=+td.dataset.j;
        state.cap.levels[i][j] = ((state.cap.levels[i][j]||0)+1)%6;
        renderCap(); autosave();
      })
    });
  }
  if(!state.cap.levels.length) ensureMatrix();
  renderCap();
  agencyEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ const v=agencyEl.value.trim(); if(!v) return; state.cap.agencies.push(v); agencyEl.value=''; renderCap(); autosave(); } });
  capEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ const v=capEl.value.trim(); if(!v) return; state.cap.caps.push(v); capEl.value=''; renderCap(); autosave(); } });
  document.getElementById('resetCap').addEventListener('click', ()=>{ state.cap.levels=[]; renderCap(); autosave(); });

  // --------------------------- Synthesis ---------------------------
  function compile(){
    const scores = computeScores().slice(0,5).map(s=>`- ${s.name}: ${(s.score*100).toFixed(0)}`).join('\n');
    const crit = state.mcda.criteria.map(c=>`- ${c.name}: ${c.w}`).join('\n');
    const risks = state.risks.map(r=>`- ${r.title} (L${r.lik}×I${r.imp})`).join('\n') || "- none";
    const cap = state.cap.agencies.map((a,i)=>{
      const avg = Math.round(100*(state.cap.levels[i].reduce((a,b)=>a+(b||0),0)/(state.cap.caps.length*5 || 1)));
      return `- ${a}: ${avg}%`;
    }).join('\n') || "- none";
    const causalNodes = state.causal.nodes.length;
    const causalLinks = state.causal.links.length;
    const md = `# ${state.meta.title || "Policy proposal"}
Domain: ${state.meta.domain}

## Brief
${state.meta.brief || "(add context)"}

## MCDA
Top instruments:
${scores || "- none"}

Criteria weights:
${crit}

## Risk overview
${risks}

## Capacity snapshot
${cap}

## Causal map
Nodes: ${causalNodes}, Links: ${causalLinks}
`;
    document.getElementById('output').textContent = md;
  }
  document.getElementById('compile').addEventListener('click', compile);
  document.getElementById('exportMd').addEventListener('click', ()=>{
    const md = document.getElementById('output').textContent || ''; 
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([md],{type:'text/markdown'})); a.download='PolicyLab_Summary.md'; a.click();
  });

  // --------------------------- Demo / Export / Import ---------------------------
  document.getElementById('presetDigital').addEventListener('click', ()=>{
    // MCDA sample
    state.mcda.instruments = [
      {name:"Conduct rules", why:"Platform fairness baseline", scores:[4,4,5,4,4,3]},
      {name:"Data portability", why:"Lower switching costs", scores:[3,3,3,4,5,3]},
      {name:"Functional separation", why:"Reduce leveraging", scores:[4,2,2,4,5,2]},
      {name:"Targeted audits", why:"Detect dark patterns", scores:[3,4,4,3,3,4]}
    ];
    renderInstruments(); drawMCDA();

    // Causal map sample
    document.getElementById('clearMap').click();
    addNode("Network effects","driver",80,70);
    addNode("High switching costs","driver",80,170);
    addNode("Conduct rules","policy",300,120);
    addNode("Portability","policy",300,220);
    addNode("Contestability ↑","outcome",540,120);
    addNode("Consumer autonomy ↑","outcome",540,220);
    state.causal.links.push(
      {a:state.causal.nodes[0].id, b:state.causal.nodes[2].id},
      {a:state.causal.nodes[1].id, b:state.causal.nodes[3].id},
      {a:state.causal.nodes[2].id, b:state.causal.nodes[4].id},
      {a:state.causal.nodes[3].id, b:state.causal.nodes[5].id}
    ); drawLinks();

    // Risks sample
    state.risks = [
      {id:crypto.randomUUID(), title:"Regulatory capture", lik:3, imp:4, causes:["Lobbying"], consq:["Weak rules"], pre:["Cooling-off"], post:["Oversight"]},
      {id:crypto.randomUUID(), title:"Under-enforcement", lik:4, imp:4, causes:["Capacity"], consq:["Non-compliance"], pre:["Budget"], post:["Audits"]},
      {id:crypto.randomUUID(), title:"Over-blocking", lik:2, imp:3, causes:["Broad rules"], consq:["Innovation harm"], pre:["Sunset"], post:["Appeals"]}
    ];
    drawRiskMap(); refreshBowTie(state.risks[0]);

    // Capacity sample
    state.cap.agencies=["Regulator","Data Protection Authority","Competition Commission"];
    state.cap.caps=["Staffing","IT systems","Legal powers","Budget","Regional presence"];
    state.cap.levels=[
      [3,3,4,3,2],
      [2,4,3,2,2],
      [4,3,4,3,2]
    ];
    renderCap();

    // Meta
    state.meta.title="Online platform conduct policy";
    state.meta.brief="Draft to address consumer autonomy and contestability in digital marketplaces via conduct rules, data portability, and targeted audits.";
    titleEl.value=state.meta.title; briefEl.value=state.meta.brief; domainEl.value=state.meta.domain;

    autosave();
  });

  document.getElementById('exportJson').addEventListener('click', ()=>{
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'})); a.download='PolicyLab_State.json'; a.click();
  });
  document.getElementById('importJson').addEventListener('click', ()=> document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', ()=>{
    const f=document.getElementById('importFile').files[0]; if(!f) return;
    const r=new FileReader(); r.onload=e=>{ try{
      const s=JSON.parse(e.target.result); Object.assign(state,s||{});
      // rehydrate UI
      renderCriteria(); renderInstruments(); drawMCDA();
      // map
      stage.querySelectorAll('.node').forEach(n=>n.remove());
      (state.causal.nodes||[]).forEach(n=> addNode(n.text,n.type,n.x,n.y));
      drawLinks();
      // risk
      drawRiskMap();
      // cap
      renderCap();
      // meta
      titleEl.value=state.meta.title||''; briefEl.value=state.meta.brief||''; domainEl.value=state.meta.domain||domainEl.value;
      autosave();
    }catch{ alert('Invalid JSON'); } };
    r.readAsText(f);
  });

  // default visible panel
  document.querySelector('nav .btn[data-panel="mcda"]').click();
  </script>
</body>
</html>
