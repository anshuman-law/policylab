<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PolicyLab | Interactive Policy Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* simple print */
    @media print {
      nav, footer, #printDoc, #resetAll, #exportMd, #saveNow, #loadNow, #exportJson, #importJsonBtn { display:none !important; }
      .shadow { box-shadow:none !important; }
    }
    canvas { image-rendering: crisp-edges; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-extrabold tracking-tight">PolicyLab</h1>
      <p class="text-sm text-gray-600">A guided portal to craft a complete policy proposal from structured inputs.</p>
    </header>

    <!-- Progress -->
    <div class="w-full bg-gray-200 h-2 rounded mb-6">
      <div id="progressBar" class="bg-blue-600 h-2 rounded" style="width: 12.5%"></div>
    </div>

    <!-- Stepper -->
    <nav class="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-6">
      <button data-step="1" class="step-btn px-3 py-2 rounded border bg-white text-left">1. Briefing <span class="text-xs ml-2" id="badge-1"></span></button>
      <button data-step="2" class="step-btn px-3 py-2 rounded border bg-white text-left">2. Problem <span class="text-xs ml-2" id="badge-2"></span></button>
      <button data-step="3" class="step-btn px-3 py-2 rounded border bg-white text-left">3. Stakeholders <span class="text-xs ml-2" id="badge-3"></span></button>
      <button data-step="4" class="step-btn px-3 py-2 rounded border bg-white text-left">4. Objectives <span class="text-xs ml-2" id="badge-4"></span></button>
      <button data-step="5" class="step-btn px-3 py-2 rounded border bg-white text-left">5. Instruments <span class="text-xs ml-2" id="badge-5"></span></button>
      <button data-step="6" class="step-btn px-3 py-2 rounded border bg-white text-left">6. Implementation <span class="text-xs ml-2" id="badge-6"></span></button>
      <button data-step="7" class="step-btn px-3 py-2 rounded border bg-white text-left">7. Monitoring <span class="text-xs ml-2" id="badge-7"></span></button>
      <button data-step="8" class="step-btn px-3 py-2 rounded border bg-white text-left">8. Synthesis <span class="text-xs ml-2" id="badge-8"></span></button>
    </nav>

    <!-- Panels -->
    <section id="panel-1" class="panel space-y-4">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-2">Welcome and Scenario</h2>
        <label class="block text-sm font-medium">Scenario title</label>
        <input id="scenarioTitle" class="w-full mt-1 p-2 border rounded" placeholder="Example: Online consumer harms in digital marketplaces" />
        <label class="block text-sm font-medium mt-4">Scenario brief</label>
        <textarea id="scenarioBrief" class="w-full mt-1 p-2 border rounded h-28" placeholder="100 to 150 words describing context, institutions, and legal landscape"></textarea>
        <label class="block text-sm font-medium mt-4">Domain</label>
        <select id="domain" class="w-full mt-1 p-2 border rounded">
          <option>Digital markets and competition</option>
          <option>Data protection and privacy</option>
          <option>Environmental regulation</option>
          <option>Public health</option>
          <option>IP and innovation policy</option>
          <option>Infrastructure and utilities</option>
        </select>
      </div>
    </section>

    <section id="panel-2" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-2">Problem Framing</h2>
        <label class="block text-sm font-medium">Problem statement</label>
        <textarea id="problemStatement" class="w-full mt-1 p-2 border rounded h-28" placeholder="Concise definition of the policy problem"></textarea>
        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium">Symptoms</label>
            <textarea id="symptoms" class="w-full mt-1 p-2 border rounded h-24" placeholder="Observable harms or failures"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium">Root causes</label>
            <textarea id="rootCauses" class="w-full mt-1 p-2 border rounded h-24" placeholder="Structural, legal, economic, or design drivers"></textarea>
          </div>
        </div>
        <label class="block text-sm font-medium mt-4">Legal baselines or precedents</label>
        <textarea id="legalBaselines" class="w-full mt-1 p-2 border rounded h-24" placeholder="Statutes, case law, regulations, standards"></textarea>
      </div>
    </section>

    <section id="panel-3" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-3">Stakeholder Mapping</h2>
        <div class="flex flex-wrap gap-2 mb-3">
          <input id="stakeName" class="p-2 border rounded" placeholder="Name or category" />
          <input id="stakeRole" class="p-2 border rounded" placeholder="Role or function" />
          <input id="stakeInterest" class="p-2 border rounded" placeholder="Interests" />
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Interest</label>
            <input id="stakeInterestScore" type="range" min="1" max="5" value="3" />
            <span id="stakeInterestView" class="text-xs text-gray-700">3</span>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Power</label>
            <input id="stakePowerScore" type="range" min="1" max="5" value="3" />
            <span id="stakePowerView" class="text-xs text-gray-700">3</span>
          </div>
          <button id="addStakeholder" class="px-3 py-2 bg-blue-600 text-white rounded">Add</button>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="overflow-x-auto">
            <table class="w-full text-sm border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">Name</th>
                  <th class="p-2 border">Role</th>
                  <th class="p-2 border">Interests</th>
                  <th class="p-2 border">Interest</th>
                  <th class="p-2 border">Power</th>
                  <th class="p-2 border">Remove</th>
                </tr>
              </thead>
              <tbody id="stakeTable"></tbody>
            </table>
          </div>
          <div class="bg-gray-50 rounded border p-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-medium">Power–Interest map</div>
              <div class="text-xs text-gray-500">Low to High</div>
            </div>
            <canvas id="stakeViz" width="520" height="360" class="w-full h-auto mt-2 bg-white rounded border"></canvas>
            <p class="text-xs text-gray-600 mt-1">Quadrants: Manage closely (high–high), Keep satisfied (high power, low interest), Keep informed (low power, high interest), Monitor (low–low).</p>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-4" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-2">Objectives and Constraints</h2>
        <label class="block text-sm font-medium">Primary objectives</label>
        <textarea id="objectives" class="w-full mt-1 p-2 border rounded h-24" placeholder="2 to 3 normative goals. Example: autonomy, fairness, contestability"></textarea>
        <label class="block text-sm font-medium mt-4">Constraints</label>
        <textarea id="constraints" class="w-full mt-1 p-2 border rounded h-24" placeholder="Legal, political, economic, administrative constraints"></textarea>
        <label class="block text-sm font-medium mt-4">Design principles</label>
        <textarea id="principles" class="w-full mt-1 p-2 border rounded h-24" placeholder="Clarity, proportionality, adaptability, transparency, subsidiarity"></textarea>
      </div>
    </section>

    <section id="panel-5" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-3">Policy Instruments</h2>
        <p class="text-sm text-gray-700 mb-2">Score each instrument on effectiveness and feasibility to see its position in the matrix.</p>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Instrument</label>
            <select id="instrumentPick" class="w-full mt-1 p-2 border rounded">
              <option>Competition remedies</option>
              <option>Conduct rules or codes</option>
              <option>Licensing or certification</option>
              <option>Disclosure or transparency</option>
              <option>Taxation or levies</option>
              <option>Procurement levers</option>
              <option>Technical standards</option>
              <option>Behavioral nudges</option>
              <option>Sandbox or pilot</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Justification</label>
            <input id="instrumentWhy" class="w-full mt-1 p-2 border rounded" placeholder="How it aligns with objectives and stakeholder realities" />
          </div>
        </div>
        <div class="flex flex-wrap items-end gap-3 mt-2">
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Effectiveness</label>
            <input id="effScore" type="range" min="1" max="5" value="3" />
            <span id="effView" class="text-xs text-gray-700">3</span>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Feasibility</label>
            <input id="feaScore" type="range" min="1" max="5" value="3" />
            <span id="feaView" class="text-xs text-gray-700">3</span>
          </div>
          <button id="addInstrument" class="px-3 py-2 bg-blue-600 text-white rounded">Add instrument</button>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <ul id="instrumentList" class="space-y-2"></ul>
          <div class="bg-gray-50 rounded border p-2">
            <div class="text-sm font-medium">Effectiveness–Feasibility matrix</div>
            <canvas id="instViz" width="520" height="360" class="w-full h-auto mt-2 bg-white rounded border"></canvas>
            <p class="text-xs text-gray-600 mt-1">Top-right are promising quick wins; bottom-left are risky or weak.</p>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-6" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-3">Implementation Plan</h2>
        <div class="grid sm:grid-cols-4 gap-2 items-end">
          <div>
            <label class="block text-sm font-medium">Task</label>
            <input id="implTask" class="w-full mt-1 p-2 border rounded" placeholder="Example: Draft rules" />
          </div>
          <div>
            <label class="block text-sm font-medium">Actor</label>
            <input id="implActor" class="w-full mt-1 p-2 border rounded" placeholder="Agency or unit" />
          </div>
          <div>
            <label class="block text-sm font-medium">Timeline</label>
            <input id="implTime" class="w-full mt-1 p-2 border rounded" placeholder="Q1 2026" />
          </div>
          <div>
            <button id="addImpl" class="w-full px-3 py-2 bg-blue-600 text-white rounded">Add</button>
          </div>
        </div>
        <div class="overflow-x-auto mt-3">
          <table class="w-full text-sm border">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 border">Task</th>
                <th class="p-2 border">Actor</th>
                <th class="p-2 border">Timeline</th>
                <th class="p-2 border">Remove</th>
              </tr>
            </thead>
            <tbody id="implTable"></tbody>
          </table>
        </div>
        <div class="bg-gray-50 rounded border p-2 mt-3">
          <div class="text-sm font-medium">Quarter timeline</div>
          <canvas id="implViz" width="900" height="160" class="w-full h-auto mt-2 bg-white rounded border"></canvas>
          <p class="text-xs text-gray-600 mt-1">Parses tokens like Q1 2026, Q3 2025. Bars show task counts by quarter.</p>
        </div>
        <label class="block text-sm font-medium mt-4">Resources or budget notes</label>
        <textarea id="resources" class="w-full mt-1 p-2 border rounded h-20" placeholder="Optional"></textarea>
      </div>
    </section>

    <section id="panel-7" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-2">Monitoring and Adaptation</h2>
        <div class="grid sm:grid-cols-4 gap-2 items-end">
          <div>
            <label class="block text-sm font-medium">Metric</label>
            <input id="metricName" class="w-full mt-1 p-2 border rounded" placeholder="Example: Switching costs index" />
          </div>
          <div>
            <label class="block text-sm font-medium">Method</label>
            <input id="metricMethod" class="w-full mt-1 p-2 border rounded" placeholder="Survey, audit, API logs" />
          </div>
          <div>
            <label class="block text-sm font-medium">Frequency</label>
            <input id="metricFreq" class="w-full mt-1 p-2 border rounded" placeholder="Quarterly" />
          </div>
          <div>
            <button id="addMetric" class="w-full px-3 py-2 bg-blue-600 text-white rounded">Add</button>
          </div>
        </div>
        <div class="overflow-x-auto mt-3">
          <table class="w-full text-sm border">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 border">Metric</th>
                <th class="p-2 border">Method</th>
                <th class="p-2 border">Frequency</th>
                <th class="p-2 border">Remove</th>
              </tr>
            </thead>
            <tbody id="metricTable"></tbody>
          </table>
        </div>
        <label class="block text-sm font-medium mt-4">Adaptive governance and sunset clauses</label>
        <textarea id="adaptiveNotes" class="w-full mt-1 p-2 border rounded h-20" placeholder="Feedback loops, review triggers, sunset timelines"></textarea>
      </div>
    </section>

    <section id="panel-8" class="panel space-y-4 hidden">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-3">Synthesis</h2>
        <p class="text-sm text-gray-700">Click compile to generate a formatted proposal. You can edit in place, copy, print, or export as Markdown.</p>
        <div class="flex flex-wrap gap-2 mb-3">
          <button id="compileBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Compile proposal</button>
          <button id="exportMd" class="px-3 py-2 bg-emerald-600 text-white rounded">Export Markdown</button>
          <button id="printDoc" class="px-3 py-2 bg-gray-800 text-white rounded">Print</button>
          <button id="resetAll" class="px-3 py-2 bg-red-600 text-white rounded">Reset</button>
          <button id="exportJson" class="px-3 py-2 bg-indigo-600 text-white rounded">Export JSON</button>
          <button id="importJsonBtn" class="px-3 py-2 bg-white border rounded">Import JSON</button>
          <input id="importJsonFile" type="file" accept="application/json" class="hidden" />
        </div>
        <article id="output" class="prose max-w-none bg-gray-50 p-4 rounded border min-h-[20rem]" contenteditable="true"></article>
      </div>
    </section>

    <!-- Footer save status -->
    <footer class="mt-6 text-xs text-gray-500 flex items-center justify-between">
      <span id="saveStatus">Autosaved</span>
      <div class="flex gap-2">
        <button id="saveNow" class="px-2 py-1 border rounded bg-white">Save now</button>
        <button id="loadNow" class="px-2 py-1 border rounded bg-white">Load saved</button>
      </div>
    </footer>
  </div>

  <script>
    // Simple state
    const state = {
      scenarioTitle: "", scenarioBrief: "", domain: "Digital markets and competition",
      problemStatement: "", symptoms: "", rootCauses: "", legalBaselines: "",
      stakeholders: [], // {name, role, interest, interestScore(1-5), powerScore(1-5)}
      objectives: "", constraints: "", principles: "",
      instruments: [], // {name, why, eff, fea}
      implementation: [], // {task, actor, time}
      resources: "",
      metrics: [], // {name, method, freq}
      adaptiveNotes: ""
    };

    // Helpers
    const $ = (id) => document.getElementById(id);
    const panels = [...document.querySelectorAll(".panel")];
    const stepBtns = [...document.querySelectorAll(".step-btn")];

    function showStep(n) {
      panels.forEach((p, i) => p.classList.toggle("hidden", i !== n - 1));
      stepBtns.forEach((b) => b.classList.remove("bg-blue-50", "border-blue-600"));
      document.querySelector(\`.step-btn[data-step="\${n}"]\`).classList.add("bg-blue-50", "border-blue-600");
      $("progressBar").style.width = completionPercent() + "%";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    stepBtns.forEach((b) => b.addEventListener("click", () => showStep(parseInt(b.dataset.step))));

    // Bind inputs
    const bindings = [
      ["scenarioTitle","scenarioTitle"],["scenarioBrief","scenarioBrief"],["domain","domain"],
      ["problemStatement","problemStatement"],["symptoms","symptoms"],["rootCauses","rootCauses"],["legalBaselines","legalBaselines"],
      ["objectives","objectives"],["constraints","constraints"],["principles","principles"],
      ["resources","resources"],["adaptiveNotes","adaptiveNotes"]
    ];
    bindings.forEach(([id, key]) => {
      $(id).addEventListener("input", e => { state[key] = e.target.value; autosave(); renderBadges(); });
    });

    // Stakeholders
    $("stakeInterestScore").addEventListener("input", e=> $("stakeInterestView").textContent = e.target.value);
    $("stakePowerScore").addEventListener("input", e=> $("stakePowerView").textContent = e.target.value);

    function renderStakeholders() {
      const tbody = $("stakeTable");
      tbody.innerHTML = "";
      state.stakeholders.forEach((s, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border">${escapeHtml(s.name)}</td>
          <td class="p-2 border">${escapeHtml(s.role)}</td>
          <td class="p-2 border">${escapeHtml(s.interest)}</td>
          <td class="p-2 border text-center">${s.interestScore}</td>
          <td class="p-2 border text-center">${s.powerScore}</td>
          <td class="p-2 border text-center"><button class="text-red-600 underline" data-i="${i}">Remove</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("button").forEach(btn => btn.addEventListener("click", () => {
        const i = parseInt(btn.dataset.i); state.stakeholders.splice(i,1); renderStakeholders(); drawStakeViz(); autosave(); renderBadges();
      }));
    }
    $("addStakeholder").addEventListener("click", () => {
      const name = $("stakeName").value.trim();
      const role = $("stakeRole").value.trim();
      const interest = $("stakeInterest").value.trim();
      const interestScore = parseInt($("stakeInterestScore").value,10)||3;
      const powerScore = parseInt($("stakePowerScore").value,10)||3;
      if (!name) return;
      state.stakeholders.push({ name, role, interest, interestScore, powerScore });
      ["stakeName","stakeRole","stakeInterest"].forEach(id => $(id).value = "");
      renderStakeholders(); drawStakeViz(); autosave(); renderBadges();
    });

    // Instruments
    $("effScore").addEventListener("input", e=> $("effView").textContent = e.target.value);
    $("feaScore").addEventListener("input", e=> $("feaView").textContent = e.target.value);

    function renderInstruments() {
      const ul = $("instrumentList");
      ul.innerHTML = "";
      state.instruments.forEach((ins, i) => {
        const li = document.createElement("li");
        li.className = "border rounded p-2 flex items-start justify-between gap-3 bg-white";
        li.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(ins.name)} <span class="text-xs text-gray-500">[Eff ${ins.eff}/5 • Fea ${ins.fea}/5]</span></div>
            <div class="text-sm text-gray-700">${escapeHtml(ins.why)}</div>
          </div>
          <button data-i="${i}" class="text-red-600 underline">Remove</button>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll("button").forEach(btn => btn.addEventListener("click", () => {
        const i = parseInt(btn.dataset.i); state.instruments.splice(i,1); renderInstruments(); drawInstViz(); autosave(); renderBadges();
      }));
    }
    $("addInstrument").addEventListener("click", () => {
      const name = $("instrumentPick").value;
      const why = $("instrumentWhy").value.trim();
      const eff = parseInt($("effScore").value,10)||3;
      const fea = parseInt($("feaScore").value,10)||3;
      if (!name) return;
      state.instruments.push({ name, why, eff, fea });
      $("instrumentWhy").value = "";
      renderInstruments(); drawInstViz(); autosave(); renderBadges();
    });

    // Implementation
    function renderImpl() {
      const tbody = $("implTable");
      tbody.innerHTML = "";
      state.implementation.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border">${escapeHtml(r.task)}</td>
          <td class="p-2 border">${escapeHtml(r.actor)}</td>
          <td class="p-2 border">${escapeHtml(r.time)}</td>
          <td class="p-2 border text-center"><button class="text-red-600 underline" data-i="${i}">Remove</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("button").forEach(btn => btn.addEventListener("click", () => {
        const i = parseInt(btn.dataset.i); state.implementation.splice(i,1); renderImpl(); drawImplViz(); autosave(); renderBadges();
      }));
    }
    $("addImpl").addEventListener("click", () => {
      const task = $("implTask").value.trim();
      const actor = $("implActor").value.trim();
      const time = $("implTime").value.trim();
      if (!task) return;
      state.implementation.push({ task, actor, time });
      ["implTask","implActor","implTime"].forEach(id => $(id).value = "");
      renderImpl(); drawImplViz(); autosave(); renderBadges();
    });

    // Metrics
    function renderMetrics() {
      const tbody = $("metricTable");
      tbody.innerHTML = "";
      state.metrics.forEach((m, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border">${escapeHtml(m.name)}</td>
          <td class="p-2 border">${escapeHtml(m.method)}</td>
          <td class="p-2 border">${escapeHtml(m.freq)}</td>
          <td class="p-2 border text-center"><button class="text-red-600 underline" data-i="${i}">Remove</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("button").forEach(btn => btn.addEventListener("click", () => {
        const i = parseInt(btn.dataset.i); state.metrics.splice(i,1); renderMetrics(); autosave(); renderBadges();
      }));
    }
    $("addMetric").addEventListener("click", () => {
      const name = $("metricName").value.trim();
      const method = $("metricMethod").value.trim();
      const freq = $("metricFreq").value.trim();
      if (!name) return;
      state.metrics.push({ name, method, freq });
      ["metricName","metricMethod","metricFreq"].forEach(id => $(id).value = "");
      renderMetrics(); autosave(); renderBadges();
    });

    // Compile Proposal
    $("compileBtn").addEventListener("click", () => {
      const md = compileMarkdown(state);
      $("output").innerHTML = markdownToHtml(md);
    });

    // Export Markdown
    $("exportMd").addEventListener("click", () => {
      const md = compileMarkdown(state);
      const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "PolicyProposal.md"; a.click();
      URL.revokeObjectURL(url);
    });

    // Print
    $("printDoc").addEventListener("click", () => window.print());

    // Export/Import JSON
    $("exportJson").addEventListener("click", ()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="PolicyLabState.json"; a.click();
      URL.revokeObjectURL(a.href);
    });
    $("importJsonBtn").addEventListener("click", ()=> $("importJsonFile").click());
    $("importJsonFile").addEventListener("change", ()=>{
      const f=$("importJsonFile").files[0]; if(!f) return;
      const r=new FileReader(); r.onload=e=>{ try{
        const s=JSON.parse(e.target.result); Object.assign(state,s||{});
        // rehydrate
        bindings.forEach(([id,key])=> { if($(id)) $(id).value = state[key] || ""; });
        renderStakeholders(); renderInstruments(); renderImpl(); renderMetrics();
        drawStakeViz(); drawInstViz(); drawImplViz(); autosave(); renderBadges();
        showStep(8);
      }catch{ alert("Invalid JSON"); } };
      r.readAsText(f);
    });

    // Save and load
    function autosave() {
      localStorage.setItem("policylab_state_v1", JSON.stringify(state));
      $("saveStatus").textContent = "Autosaved";
      $("progressBar").style.width = completionPercent() + "%";
    }
    $("saveNow").addEventListener("click", autosave);
    $("loadNow").addEventListener("click", loadSaved);

    function loadSaved() {
      const saved = localStorage.getItem("policylab_state_v1");
      if (!saved) return;
      const s = JSON.parse(saved);
      Object.assign(state, s);
      bindings.forEach(([id, key]) => { if ($(id)) $(id).value = state[key] || ""; });
      renderStakeholders(); renderInstruments(); renderImpl(); renderMetrics();
      drawStakeViz(); drawInstViz(); drawImplViz();
      $("saveStatus").textContent = "Loaded";
      renderBadges();
    }

    // Utils
    function escapeHtml(str="") {
      return str.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    // Completion score (rough but useful)
    function completionPercent(){
      let score=0, total=8;
      if(state.scenarioTitle && state.scenarioBrief) score++;
      if(state.problemStatement && (state.symptoms||state.rootCauses)) score++;
      if(state.stakeholders.length) score++;
      if(state.objectives) score++;
      if(state.instruments.length) score++;
      if(state.implementation.length) score++;
      if(state.metrics.length) score++;
      if(true) score++; // synthesis always available
      return Math.max(12.5, Math.round((score/total)*100));
    }
    function renderBadges(){
      const set = (n, txt, ok)=> { const el=$("badge-"+n); el.textContent = txt; el.className = ok? "text-green-600" : "text-gray-400"; };
      set(1, state.scenarioTitle? "✓" : "•", !!state.scenarioTitle);
      set(2, state.problemStatement? "✓" : "•", !!state.problemStatement);
      set(3, state.stakeholders.length? state.stakeholders.length : "0", !!state.stakeholders.length);
      set(4, state.objectives? "✓" : "•", !!state.objectives);
      set(5, state.instruments.length? state.instruments.length : "0", !!state.instruments.length);
      set(6, state.implementation.length? state.implementation.length : "0", !!state.implementation.length);
      set(7, state.metrics.length? state.metrics.length : "0", !!state.metrics.length);
      set(8, "ready", true);
      $("progressBar").style.width = completionPercent() + "%";
    }

    // Markdown compiler
    function compileMarkdown(s) {
      const stakeLines = s.stakeholders.map(x => `- ${x.name} | role ${x.role} | interests ${x.interest} | interest ${x.interestScore}/5 | power ${x.powerScore}/5`).join("\n");
      const insLines = s.instruments.map(x => `- ${x.name}: ${x.why} (effectiveness ${x.eff}/5; feasibility ${x.fea}/5)`).join("\n");
      const implLines = s.implementation.map(x => `- ${x.task} | ${x.actor} | ${x.time}`).join("\n");
      const metricLines = s.metrics.map(x => `- ${x.name} | ${x.method} | ${x.freq}`).join("\n");

      return `# ${s.scenarioTitle || "Policy Proposal"}
Domain: ${s.domain}

## Scenario Brief
${s.scenarioBrief}

## 1. Problem Framing
**Problem statement**  
${s.problemStatement}

**Symptoms**  
${s.symptoms}

**Root causes**  
${s.rootCauses}

**Legal baselines or precedents**  
${s.legalBaselines}

## 2. Stakeholder Mapping
${stakeLines || "- None added"}

## 3. Objectives and Constraints
**Objectives**  
${s.objectives}

**Constraints**  
${s.constraints}

**Design principles**  
${s.principles}

## 4. Policy Instruments
${insLines || "- None added"}

## 5. Implementation Plan
${implLines || "- None added"}

**Resources or budget notes**  
${s.resources}

## 6. Monitoring and Adaptation
**Metrics**  
${metricLines || "- None added"}

**Adaptive governance and sunset**  
${s.adaptiveNotes}

## 7. Executive Summary
Provide a 150 word summary here after review.
`;
    }

    // Tiny Markdown to HTML for headings and simple lists
    function markdownToHtml(md) {
      let h = escapeHtml(md);
      h = h.replace(/^### (.*)$/gm, "<h3 class='text-lg font-semibold mt-4 mb-2'>$1</h3>");
      h = h.replace(/^## (.*)$/gm, "<h2 class='text-xl font-bold mt-6 mb-2'>$1</h2>");
      h = h.replace(/^# (.*)$/gm, "<h1 class='text-2xl font-extrabold mt-2 mb-2'>$1</h1>");
      h = h.replace(/^\- (.*)$/gm, "<li>$1</li>");
      h = h.replace(/(<li>.*<\/li>)(\n<li>.*<\/li>)+/gs, match => `<ul class="list-disc pl-6 space-y-1">${match}</ul>`);
      h = h.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      h = h.replace(/\n\n/g, "<br><br>");
      return h;
    }

    // ---- Visuals (no external libs) ----
    function drawStakeViz(){
      const c = $("stakeViz"); if(!c) return;
      const ctx = c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height);
      const W=c.width, H=c.height, pad=36;
      // axes box
      ctx.strokeStyle="#d1d5db"; ctx.strokeRect(pad,pad,W-2*pad,H-2*pad);
      // grid labels
      ctx.fillStyle="#6b7280"; ctx.font="12px ui-sans-serif";
      ctx.fillText("Interest →", W/2-30, H-8);
      ctx.save(); ctx.translate(12, H/2+30); ctx.rotate(-Math.PI/2); ctx.fillText("Power ↑",0,0); ctx.restore();
      // quadrants
      ctx.strokeStyle="#e5e7eb"; ctx.beginPath();
      ctx.moveTo(W/2, pad); ctx.lineTo(W/2, H-pad);
      ctx.moveTo(pad, H/2); ctx.lineTo(W-pad, H/2);
      ctx.stroke();
      // points
      const X=(v)=> pad + (v-1)/4*(W-2*pad);
      const Y=(v)=> H-pad - (v-1)/4*(H-2*pad);
      state.stakeholders.forEach(s=>{
        const x = X(s.interestScore||3), y = Y(s.powerScore||3);
        ctx.fillStyle="#2563eb"; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
        ctx.fillStyle="#374151"; ctx.fillText(String(s.name).slice(0,22), x+8, y+4);
      });
    }

    function drawInstViz(){
      const c=$("instViz"); if(!c) return;
      const ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height);
      const W=c.width, H=c.height, pad=36;
      ctx.strokeStyle="#d1d5db"; ctx.strokeRect(pad,pad,W-2*pad,H-2*pad);
      ctx.strokeStyle="#e5e7eb"; ctx.beginPath();
      ctx.moveTo(W/2, pad); ctx.lineTo(W/2, H-pad);
      ctx.moveTo(pad, H/2); ctx.lineTo(W-pad, H/2);
      ctx.stroke();
      ctx.fillStyle="#6b7280"; ctx.font="12px ui-sans-serif";
      ctx.fillText("Feasibility →", W/2-30, H-8);
      ctx.save(); ctx.translate(12,H/2+30); ctx.rotate(-Math.PI/2); ctx.fillText("Effectiveness ↑",0,0); ctx.restore();
      const X=(v)=> pad + (v-1)/4*(W-2*pad);
      const Y=(v)=> H-pad - (v-1)/4*(H-2*pad);
      state.instruments.forEach(ins=>{
        const x=X(ins.fea||3), y=Y(ins.eff||3);
        ctx.fillStyle="#10b981"; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
        ctx.fillStyle="#374151"; ctx.fillText(String(ins.name).slice(0,22), x+8, y+4);
      });
    }

    function parseQuarter(str){
      // accepts "Q1 2026" etc.
      const m = String(str).trim().match(/Q([1-4])\s+(\d{4})/i);
      if(!m) return null;
      const q = parseInt(m[1],10), y = parseInt(m[2],10);
      return {q,y, key:`${y}-Q${q}`};
    }
    function drawImplViz(){
      const c=$("implViz"); if(!c) return;
      const ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height);
      const W=c.width, H=c.height, pad=36;
      const counts = {};
      state.implementation.forEach(r=>{
        const p=parseQuarter(r.time); if(p){ counts[p.key]=(counts[p.key]||0)+1; }
      });
      const keys = Object.keys(counts).sort((a,b)=>{
        const [ay,aq]=a.split("-Q").map(Number); const [by,bq]=b.split("-Q").map(Number);
        return ay===by? aq-bq : ay-by;
      });
      if(!keys.length){ ctx.fillStyle="#6b7280"; ctx.fillText("Add Qn YYYY to timelines to populate.", pad, pad+12); return; }
      const max = Math.max(...keys.map(k=>counts[k]));
      // axis
      ctx.strokeStyle="#d1d5db"; ctx.strokeRect(pad,pad,W-2*pad,H-2*pad);
      // bars
      const bw = Math.max(10, (W-2*pad)/keys.length - 6);
      keys.forEach((k,i)=>{
        const x = pad + i*((W-2*pad)/keys.length) + 3;
        const h = (H-2*pad)*(counts[k]/max);
        ctx.fillStyle="#60a5fa"; ctx.fillRect(x, H-pad-h, bw, h);
        if(keys.length<=12){ ctx.fillStyle="#6b7280"; ctx.font="10px ui-sans-serif"; ctx.fillText(k, x, H-pad+12); }
      });
    }

    // Init
    function init(){
      showStep(1);
      loadSaved();
      renderBadges();
      drawStakeViz(); drawInstViz(); drawImplViz();
    }
    init();
  </script>
</body>
</html>
